<?xml version="1.0" encoding="utf-8" ?>
<!-- 报警视图的主要布局文件 -->
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:KupaKuper_HmiView.ContentViewModes"
             xmlns:CsvTable="clr-namespace:KupaKuper_MauiControl.Controls;assembly=KupaKuper_MauiControl"
             x:DataType="local:AlarmViewVM"
             x:Class="KupaKuper_HmiView.ContentViews.AlarmView"
             xmlns:behaviors="clr-namespace:KupaKuper_MauiControl.Converters;assembly=KupaKuper_MauiControl"
             xmlns:localization="clr-namespace:LocalizationResourceManager.Maui;assembly=LocalizationResourceManager.Maui">
    <ContentView.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/MyStyles.xaml;assembly=KupaKuper_MauiControl" />
                <ResourceDictionary Source="/Resources/MyStyles.xaml;assembly=KupaKuper_HmiView" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </ContentView.Resources>
    <!-- 报警视图的主要布局，使用Grid分为上下两行和左右两列 -->
    <Grid RowDefinitions="Auto,*" ColumnDefinitions="*,300">
        <!-- 顶部工具栏，包含日期选择、过滤和搜索功能 -->
        <Grid Grid.Row="0"
              Grid.ColumnSpan="2"
              ColumnDefinitions="Auto,Auto,*,Auto,Auto"
              Padding="10"
              ColumnSpacing="10">

            <!-- 日期选择器：用于选择要查看的报警日期 -->
            <DatePicker Grid.Column="0"
                        Date="{Binding SelectedDate}"
                        Format="yyyy-MM-dd"
                        DateSelected="DatePicker_DateSelected" />

            <!-- 过滤类型选择器(全部/报警/提示) -->
            <Border Grid.Column="1"
                    StrokeShape="RoundRectangle 20"
                    Stroke="{StaticResource Gray300}"
                    StrokeThickness="1"
                    BackgroundColor="{AppThemeBinding Light={StaticResource LightBackColor}, Dark={StaticResource DarkBackColor}}"
                    Padding="2">
                <Grid ColumnDefinitions="*,*,*" BackgroundColor="Transparent">

                    <!-- 带动画效果的选择指示器：显示当前选中的过滤类型 -->
                    <Border x:Name="SelectionIndicator"
                            Grid.Column="{Binding SelectedFilterType, Converter={StaticResource FilterTypeToColumnConverter}}"
                            BackgroundColor="{StaticResource blueColor}"
                            StrokeShape="RoundRectangle 14"
                            HorizontalOptions="Fill"
                            Margin="1">
                        <Border.Behaviors>
                            <behaviors:IndicatorAnimationBehavior />
                        </Border.Behaviors>
                    </Border>

                    <!-- 三个过滤按钮：全部、报警、提示 -->
                    <Button Grid.Column="0"
                            Text="全部"
                            FontSize="14"
                            Command="{Binding SetFilterTypeCommand}"
                            CommandParameter="{x:Static local:AlarmFilterType.All}"
                            BackgroundColor="Transparent"
                            TextColor="{Binding SelectedFilterType, Converter={StaticResource FilterTypeToTextColorConverter}, ConverterParameter=All}" />

                    <Button Grid.Column="1"
                            Text="报警"
                            FontSize="14"
                            Command="{Binding SetFilterTypeCommand}"
                            CommandParameter="{x:Static local:AlarmFilterType.Alarm}"
                            BackgroundColor="Transparent"
                            TextColor="{Binding SelectedFilterType, Converter={StaticResource FilterTypeToTextColorConverter}, ConverterParameter=Alarm}" />

                    <Button Grid.Column="2"
                            Text="提示"
                            FontSize="14"
                            Command="{Binding SetFilterTypeCommand}"
                            CommandParameter="{x:Static local:AlarmFilterType.Info}"
                            BackgroundColor="Transparent"
                            TextColor="{Binding SelectedFilterType, Converter={StaticResource FilterTypeToTextColorConverter}, ConverterParameter=Info}" />
                </Grid>
            </Border>

            <!-- 搜索栏：用于搜索报警内容或工站 -->
            <SearchBar Grid.Column="2"
                      Text="{Binding SearchText}"
                      Placeholder="搜索报警内容或工站"
                      SearchCommand="{Binding SearchAlarmsCommand}"
                      TextChanged="SearchBar_TextChanged" />

            <!-- 功能按钮：导出Excel和刷新 -->
            <Button Grid.Column="3"
                    Text="导出Excel"
                    BackgroundColor="{StaticResource blueColor}"
                    Command="{Binding ExportToExcelCommand}"
                    Margin="0,0,10,0" />

            <Button Grid.Column="4"
                    Text="刷新"
                    BackgroundColor="{StaticResource blueColor}"
                    Command="{Binding UpDataAlarmsCommand}" />
        </Grid>

        <!-- 左侧报警历史记录表格替换为CsvTable -->
        <CsvTable:CsvTable Grid.Row="1"
                            Grid.Column="0"
                            x:Name="AlarmTable"
                            DataSource="{Binding AlarmRecordsData}"
                            IsSearchVisible="False"
                            Margin="10" />

        <!-- 右侧实时报警显示框 -->
        <Border Grid.Row="1"
                Grid.Column="1"
                Stroke="{StaticResource Gray300}"
                StrokeThickness="1"
                BackgroundColor="Transparent"
                Margin="10">
            <Grid RowDefinitions="Auto,*">
                <!-- 实时报警标题和计数 -->
                <Grid BackgroundColor="{AppThemeBinding Light={StaticResource LightButtonColor}, Dark={StaticResource DarkButtonColor}}"
                      Padding="10,5">
                    <Label Text="实时报警"
                           FontAttributes="Bold"
                           HorizontalOptions="Start" />
                    <Label Text="{Binding ActiveAlarmCount, StringFormat='共 {0} 条'}"
                           HorizontalOptions="End" />
                </Grid>

                <!-- 实时报警列表 -->
                <CollectionView Grid.Row="1"
                              ItemsSource="{Binding ActiveAlarms}"
                              Margin="0,0">
                    <!-- 实时报警项模板 -->
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="local:AlarmRecord">
                            <Grid Padding="2,5"
                                  RowDefinitions="Auto,Auto"
                                  RowSpacing="1">
                                <!-- 报警头部：类型、工站和时间 -->
                                <Grid ColumnDefinitions="Auto,*,Auto"
                                      BackgroundColor="{AppThemeBinding Light={StaticResource Key=LightLineUpColor}, Dark={StaticResource Key=DarkLineUpColor}}">
                                    <Label Grid.Column="0"
                                           Text="{Binding Type}"
                                           TextColor="{Binding Type, Converter={StaticResource AlarmTypeColorConverter}}"
                                           FontAttributes="Bold" />
                                    <Label Grid.Column="1"
                                           Text="{Binding Station}"
                                           Margin="10,0" />
                                    <Label Grid.Column="2"
                                           Text="{Binding Time, StringFormat='{0:HH:mm:ss}'}"
                                           FontSize="12" />
                                </Grid>
                                <!-- 报警内容 -->
                                <Label Grid.Row="1"
                                       Text="{Binding Content}"
                                       BackgroundColor="Transparent"
                                       TextColor="{AppThemeBinding Light={StaticResource Key=LightTextColor}, Dark={StaticResource Key=DarkTextColor}}" />
                                <!-- 报警项背景 -->
                                <Grid.Background>
                                    <SolidColorBrush Color="{AppThemeBinding Light={StaticResource Key=LightButtonColor}, Dark={StaticResource Key=DarkButtonColor}}" />
                                </Grid.Background>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <!-- 无实时报警时的显示内容 -->
                    <CollectionView.EmptyView>
                        <Label Text="暂无实时报警"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="{StaticResource Gray500}" />
                    </CollectionView.EmptyView>
                </CollectionView>
            </Grid>
        </Border>
    </Grid>
</ContentView>